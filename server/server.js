import express from "express";
import bcrypt from "bcryptjs";
import db from "./db.js"; // Import à¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸à¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¹€à¸£à¸²à¸ªà¸£à¹‰à¸²à¸‡à¹„à¸§à¹‰

const app = express();
const port = 3001; // à¸«à¸£à¸·à¸­ Port à¸­à¸·à¹ˆà¸™à¹† à¸—à¸µà¹ˆà¸„à¸¸à¸“à¸•à¹‰à¸­à¸‡à¸à¸²à¸£

// Middleware à¹€à¸žà¸·à¹ˆà¸­à¹ƒà¸«à¹‰ Express à¸­à¹ˆà¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹à¸šà¸š JSON à¸ˆà¸²à¸ Request Body à¹„à¸”à¹‰
app.use(express.json());

// à¸ªà¸£à¹‰à¸²à¸‡ API Endpoint à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™ (Register/Sign Up)
// à¹ƒà¸Šà¹‰à¹€à¸¡à¸˜à¸­à¸” POST à¹€à¸žà¸£à¸²à¸°à¹€à¸›à¹‡à¸™à¸à¸²à¸£ "à¸ªà¸£à¹‰à¸²à¸‡" à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸«à¸¡à¹ˆ
app.post("/api/register", async (req, res) => {
  try {
    // 1. à¸£à¸±à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸à¸«à¸™à¹‰à¸²à¸Ÿà¸­à¸£à¹Œà¸¡ (Request Body)
    const { username, email, password } = req.body;

    // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸„à¸£à¸šà¸–à¹‰à¸§à¸™à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
    if (!username || !email || !password) {
      return res.status(400).json({ message: "à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸«à¹‰à¸„à¸£à¸šà¸–à¹‰à¸§à¸™" });
    }

    // 2. à¹€à¸‚à¹‰à¸²à¸£à¸«à¸±à¸ªà¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™ (Hashing) à¹€à¸žà¸·à¹ˆà¸­à¸„à¸§à¸²à¸¡à¸›à¸¥à¸­à¸”à¸ à¸±à¸¢
    const salt = await bcrypt.genSalt(10); // à¸ªà¸£à¹‰à¸²à¸‡à¸•à¸±à¸§à¸ªà¸¸à¹ˆà¸¡à¹€à¸žà¸·à¹ˆà¸­à¹€à¸žà¸´à¹ˆà¸¡à¸„à¸§à¸²à¸¡à¸›à¸¥à¸­à¸”à¸ à¸±à¸¢
    const hashedPassword = await bcrypt.hash(password, salt);

    // 3. à¸ªà¸£à¹‰à¸²à¸‡à¸„à¸³à¸ªà¸±à¹ˆà¸‡ SQL à¹€à¸žà¸·à¹ˆà¸­à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸‡à¸•à¸²à¸£à¸²à¸‡ users
    // (à¸ªà¸¡à¸¡à¸•à¸´à¸§à¹ˆà¸²à¸„à¸¸à¸“à¸¡à¸µà¸•à¸²à¸£à¸²à¸‡à¸Šà¸·à¹ˆà¸­ users à¹à¸¥à¸°à¸¡à¸µà¸„à¸­à¸¥à¸±à¸¡à¸™à¹Œ id, username, email, password)
    const sql = "INSERT INTO users (username, email, password) VALUES (?, ?, ?)";
    const values = [username, email, hashedPassword];

    // 4. à¸ªà¹ˆà¸‡à¸„à¸³à¸ªà¸±à¹ˆà¸‡ SQL à¹„à¸›à¸¢à¸±à¸‡à¸à¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥
    db.query(sql, values, (err, result) => {
      if (err) {
        console.error("à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥:", err);
        // à¸­à¸²à¸ˆà¸ˆà¸°à¹€à¸à¸´à¸”à¸ˆà¸²à¸ username à¸«à¸£à¸·à¸­ email à¸‹à¹‰à¸³
        return res.status(500).json({ message: "à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¹„à¸”à¹‰" });
      }

      // 5. à¸ªà¹ˆà¸‡à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œà¸à¸¥à¸±à¸šà¹„à¸›à¹ƒà¸«à¹‰ Client (Frontend)
      console.log("à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¹ƒà¸«à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ:", result);
      res.status(201).json({ message: "à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!" });
    });

  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "à¸¡à¸µà¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¹€à¸à¸´à¸”à¸‚à¸¶à¹‰à¸™à¹ƒà¸™à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œ" });
  }
});

// à¹€à¸£à¸´à¹ˆà¸¡à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™à¸‚à¸­à¸‡à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œ
app.listen(port, () => {
  console.log(`ðŸš€ Server is running on http://localhost:${port}`);
});